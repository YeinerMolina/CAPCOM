<div class="container">
  <div class="contenedor__banner">
    <div class="details">
      <h2>DETERMINACIÓN DEL NIVEL DE RIESGO</h2>
    </div>
  </div>

  <p-card>
    <div class="container_form">
      <p-tabView [(activeIndex)]="activeIndex">
        <p-tabPanel header="Estructura">
          <ng-container *ngTemplateOutlet="estructura"></ng-container>
        </p-tabPanel>
        <p-tabPanel header="Lineas conectadas">
          <ng-container *ngTemplateOutlet="lineas"></ng-container>
        </p-tabPanel>
        <p-tabPanel header="Carácteristicas resistivas">
          <ng-container *ngTemplateOutlet="resistiva"></ng-container>
        </p-tabPanel>
      </p-tabView>
    </div>
  </p-card>
  <p-button (onClick)="calcular()"></p-button>
</div>

<ng-template #estructura [formGroup]="form">
  <div class="grid">
    <div class="col-4">
      <div class="p-fluid grid">
        <div class="field col-6">
          <div class="p-inputgroup">
            <div class="p-float-label">
              <p-inputNumber
                formControlName="altura"
                [useGrouping]="false"
              ></p-inputNumber>
              <label>Altura</label>
            </div>
            <span class="p-inputgroup-addon">m</span>
          </div>
          <small class="p-error" *ngIf="validateField('altura')"
            >Campo invalido</small
          >
        </div>
        <div class="field col-6">
          <div class="p-inputgroup">
            <div class="p-float-label">
              <p-inputNumber
                formControlName="longitud"
                [useGrouping]="false"
              ></p-inputNumber>
              <label>Longitud</label>
            </div>
            <span class="p-inputgroup-addon">m</span>
          </div>
          <small class="p-error" *ngIf="validateField('longitud')"
            >Campo invalido</small
          >
        </div>
        <div class="field col-6">
          <div class="p-inputgroup">
            <div class="p-float-label">
              <p-inputNumber
                formControlName="ancho"
                [useGrouping]="false"
              ></p-inputNumber>
              <label>Ancho</label>
            </div>
            <span class="p-inputgroup-addon">m</span>
          </div>
          <small class="p-error" *ngIf="validateField('ancho')"
            >Campo invalido</small
          >
        </div>
        <div class="field col-6">
          <div class="p-inputgroup">
            <div class="p-float-label">
              <p-inputNumber
                formControlName="areaRecoleccion"
                [useGrouping]="false"
              ></p-inputNumber>
              <label>Área de recolección</label>
            </div>
            <span class="p-inputgroup-addon">m</span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-3">
      <div class="p-fluid grid">
        <div class="field col-12">
          <div class="flex-auto">
            <span class="p-float-label">
              <p-dropdown
                class="w-full"
                formControlName="situacionRelativa"
                [style]="{ minWidth: '100%', maxWidth: '100%' }"
                placeholder="Situación relativa de la estructura"
                [options]="configService.situacionEstructura"
                optionLabel="name"
                optionValue="value"
              ></p-dropdown>
              <label> Situación relativa de la estructura </label>
            </span>
          </div>
          <small class="p-error" *ngIf="validateField('situacionRelativa')"
            >Campo invalido</small
          >
        </div>
        <div class="field col-12">
          <div class="flex-auto">
            <div class="p-float-label">
              <p-inputNumber
                formControlName="densidadDescargasAtmosféricas"
                [useGrouping]="false"
              ></p-inputNumber>
              <label>Densidad de descargas atmosféricas</label>
            </div>
            <small
              class="p-error"
              *ngIf="validateField('densidadDescargasAtmosféricas')"
              >Campo invalido</small
            >
          </div>
        </div>
      </div>
    </div>
    <div class="col-3">
      <!-- <div class="field col-12">
          <div class="flex-auto">
            <span class="p-float-label">
              <p-dropdown
                class="w-full"
                [style]="{ minWidth: '100%', maxWidth: '100%' }"
                placeholder="Tipo de transformador"
                [options]="configService.tipoTransformador"
                optionLabel="name"
                optionValue="value"
              ></p-dropdown>
              <label> Tipo de transformador </label>
            </span>
          </div>
        </div> -->
    </div>
  </div>
  <div class="grid">
    <div class="col-4">
      <p-panel header="Medidas de protección a seres vivos">
        <div class="flex flex-column gap-2">
          <div class="flex flex-row justify-content-between h-full gap-2">
            Sin medidas de protección
            <p-checkbox
              (onChange)="checkToggle()"
              formControlName="sinMedidaProteccion"
              [binary]="true"
            ></p-checkbox>
          </div>
          <div class="flex flex-row justify-content-between h-full gap-2">
            Avisos de peligro
            <p-checkbox
              (onChange)="checkToggle()"
              formControlName="avisosDeAdvertencia"
              [binary]="true"
            ></p-checkbox>
          </div>
          <div class="flex flex-row justify-content-between h-full gap-2">
            Aislamiento eléctrico de partes expuestas
            <p-checkbox
              (onChange)="checkToggle()"
              formControlName="aislamientoElectrico"
              [binary]="true"
            ></p-checkbox>
          </div>
          <div class="flex flex-row justify-content-between h-full gap-2">
            Equipotencialización efectiva del terreno
            <p-checkbox
              (onChange)="checkToggle()"
              formControlName="equipotencializacion"
              [binary]="true"
            ></p-checkbox>
          </div>
          <div class="flex flex-row justify-content-between h-full gap-2">
            Restricciones físicas o de uso de armadura metálica del edificio
            como conducto de bajada
            <p-checkbox
              (onChange)="checkToggle()"
              formControlName="restricciones"
              [binary]="true"
            ></p-checkbox>
          </div>
        </div>
      </p-panel>
    </div>
    <!-- <div class="col-3">
      <div class="flex flex-column w-full">
        <div class="flex flex-row w-full align-items-center gap-2">
          <p-panel
            class="w-full h-full gap-2"
            header="Protección interna contra rayos"
          >
            <div
              class="flex flex-row justify-content-start align-items-center h-full gap-2"
            >
              ¿Cuenta con sistema de protección coordinado?
              <p-toggleButton
                formControlName="proteccionRayo"
                onLabel="SÍ"
                offLabel="NO"
              ></p-toggleButton>
            </div>
            <div
              class="flex flex-row justify-content-between flex-wrap w-full gap-2 pt-4"
              *ngIf="validateProteccion('proteccionRayo')"
            >
              <div class="flex flex-column w-full py-2">
                <span class="p-float-label">
                  <p-dropdown
                    class="w-full"
                    formControlName="proteccionInterna"
                    [options]="configService.nivelProteccionRayo"
                    optionLabel="name"
                    optionValue="value"
                    [style]="{ minWidth: '100%', maxWidth: '100%' }"
                    placeholder="Nivel de protección"
                  ></p-dropdown>
                  <label> Nivel de protección </label>
                </span>
              </div>
            </div>
          </p-panel>
        </div>
      </div>
    </div>
    <div class="col-3">
      <div class="flex flex-column">
        <div class="flex flex-row align-items-center gap-2">
          <p-panel
            class="w-full h-full gap-2"
            header="Protección a la estructura"
          >
            <div
              class="flex flex-row justify-content-between flex-wrap align-items-center h-full gap-2"
            >
              ¿Cuenta con protección?
              <p-toggleButton
                formControlName="proteccionEstructura"
                onLabel="SÍ"
                offLabel="NO"
              ></p-toggleButton>
            </div>
            <div
              class="flex flex-row justify-content-start w-full gap-2 pt-4"
              *ngIf="validateProteccion('proteccionEstructura')"
            >
              <div class="flex flex-column w-full py-2">
                <span class="p-float-label">
                  <p-dropdown
                    class="w-full"
                    formControlName="proteccionAEstructura"
                    [options]="configService.nivelProteccion"
                    optionLabel="name"
                    optionValue="value"
                    [style]="{ minWidth: '100%', maxWidth: '100%' }"
                    placeholder="Nivel de protección"
                  ></p-dropdown>
                  <label> Nivel de protección </label>
                </span>
              </div>
            </div>
          </p-panel>
        </div>
      </div>
    </div>-->
  </div>
</ng-template>

<ng-template #lineas [formGroup]="form">
  <p-table formArrayName="lineas" [value]="lineasForm.controls">
    <ng-template pTemplate="header">
      <tr>
        <th>Tipo de línea</th>
        <th>Longitud</th>
        <th>Número sobretenciones mayores a 1kV/año</th>
        <th>Factor de la instalación</th>
        <th>Factor medioambiental</th>
        <th>Eliminar</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-rowIndex="rowIndex">
      <tr [formGroup]="getFormLinea(rowIndex)">
        <td>
          <p-dropdown
            appendTo="body"
            [style]="{ minWidth: '100%', maxWidth: '100%' }"
            placeholder="Tipo de linea"
            [options]="configService.factorTipoLinea"
            optionLabel="name"
            optionValue="value"
            formControlName="tipoLinea"
          ></p-dropdown>
          <small
            class="p-error"
            *ngIf="validateField('tipoLinea', rowIndex + 1)"
            >Campo invalido</small
          >
        </td>
        <td>
          <div class="p-float-label">
            <p-inputNumber
              formControlName="longitud"
              [useGrouping]="false"
              class="w-full"
            ></p-inputNumber>
            <small
              class="p-error"
              *ngIf="validateField('longitud', rowIndex + 1)"
              >Campo invalido</small
            >
          </div>
        </td>
        <td>
          <div class="p-float-label">
            <p-inputNumber
              formControlName="nSobretenciones"
              [useGrouping]="false"
              class="w-full"
            ></p-inputNumber>
            <small
              class="p-error"
              *ngIf="validateField('nSobretenciones', rowIndex + 1)"
              >Campo invalido</small
            >
          </div>
        </td>
        <td>
          <p-dropdown
            appendTo="body"
            [style]="{ minWidth: '100%', maxWidth: '100%' }"
            placeholder="Tipo de línea"
            [options]="configService.tipoAcometida"
            optionLabel="name"
            optionValue="value"
            formControlName="fInstalacion"
          ></p-dropdown>
          <small
            class="p-error"
            *ngIf="validateField('fInstalacion', rowIndex + 1)"
            >Campo invalido</small
          >
        </td>
        <td>
          <p-dropdown
            appendTo="body"
            [style]="{ minWidth: '100%', maxWidth: '100%' }"
            placeholder="Tipo de ambiente"
            [options]="configService.tipoAmbiente"
            optionLabel="name"
            optionValue="value"
            formControlName="fMedio"
          ></p-dropdown>
          <small class="p-error" *ngIf="validateField('fMedio', rowIndex + 1)"
            >Campo invalido</small
          >
        </td>
        <td>
          <p-button icon="pi pi-trash" (click)="deleteLine(rowIndex)">
          </p-button>
        </td>
      </tr>
    </ng-template>
  </p-table>
  <div
    class="flex justify-content-center w-full h-2 border-top-1 border-bottom-1 border-bluegray-100"
    *ngIf="!lineasForm.controls.length"
  >
    <span class="p-2"> No hay líneas agregadas </span>
  </div>
  <div class="pt-3">
    <p-button
      label="Agregar línea"
      icon="pi pi-plus"
      styleClass="p-button-outlined"
      (click)="addLine()"
    ></p-button>
  </div>

  <!-- <div class="grid">
    <div class="col-9">
      <div class="p-fluid grid py-1" [formGroup]="form">
        <div class="field col-3">
          <span class="p-float-label">
            <p-dropdown
              class="w-full"
              [style]="{ minWidth: '100%' }"
              placeholder="Tipo de acometida"
              [options]="configService.tipoAcometida"
              optionLabel="name"
              optionValue="value"
            ></p-dropdown>
            <label> Tipo de acometida </label>
          </span>
        </div>
        <div class="field col-3">
          <div class="p-inputgroup">
            <div class="p-float-label">
              <p-inputNumber [useGrouping]="false"></p-inputNumber>
              <label>Longitud</label>
            </div>
            <span class="p-inputgroup-addon">m</span>
          </div>
        </div>
        <div class="field col-3">
          <div class="p-inputgroup">
            <div class="p-float-label">
              <p-inputNumber [useGrouping]="false"></p-inputNumber>
              <label>Altura</label>
            </div>
            <span class="p-inputgroup-addon">m</span>
          </div>
        </div>
        <div class="col-3">
          <div class="flex flex-column w-full">
            <div class="field">
              <div class="flex-auto">
                <span class="p-float-label">
                  <p-dropdown
                    class="w-full"
                    formControlName="tipoCableAcometida"
                    [options]="configService.tipoCableAcometida"
                    optionLabel="name"
                    optionValue="value"
                    [style]="{ minWidth: '100%', maxWidth: '100%' }"
                    placeholder="Tipo de cable de acometida"
                  ></p-dropdown>
                  <label> Tipo de cable de acometida </label>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="grid py-1 flex">
        <div class="field col-4">
          <div class="p-inputgroup">
            <div class="p-float-label">
              <p-inputNumber [useGrouping]="false"></p-inputNumber>
              <label>Altura del punto de ingreso de la acometida</label>
            </div>
            <span class="p-inputgroup-addon">m</span>
          </div>
        </div>

        <div class="field col-4">
          <div class="p-inputgroup">
            <div class="p-float-label">
              <p-inputNumber [useGrouping]="false"></p-inputNumber>
              <label>Altura de la acometida externa</label>
            </div>
            <span class="p-inputgroup-addon">m</span>
          </div>
        </div>

        <div class="field col-4">
          <div class="flex flex-column w-full">
            <div class="field">
              <div class="flex-auto">
                <span class="p-float-label">
                  <p-dropdown
                    class="w-full"
                    [options]="configService.tensionMinima"
                    optionLabel="name"
                    optionValue="value"
                    [style]="{ minWidth: '100%', maxWidth: '100%' }"
                    placeholder="Tensión mínima soportable [kV]"
                  ></p-dropdown>
                  <label> Tensión mínima soportable [kV] </label>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-3">
      <div class="flex flex-column w-full">
        <div class="flex flex-row w-full align-items-center gap-2 py-1">
          <p-panel
            class="w-full h-full gap-2"
            header="DPS conectado a la acometida"
          >
            <div
              class="flex flex-row justify-content-between flex-wrap align-items-center h-full gap-2 py-2"
            >
              ¿Cumple la normativa nacional vigente?
              <p-toggleButton
                formControlName="normativaDPS"
                onLabel="SÍ"
                offLabel="NO"
              ></p-toggleButton>
            </div>

            <div
              class="flex flex-row justify-content-between flex-wrap align-items-center h-full gap-2 py-2"
            >
              <small class="w-9">
                ¿Se encuentra conectado a la entrada de la acometida?
              </small>
              <p-toggleButton onLabel="SÍ" offLabel="NO"></p-toggleButton>
            </div>
          </p-panel>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="col-6">
      <p-panel class="w-full h-full gap-2" header="Acometidas de potencia">
        <div class="grid">
          <div class="col-4">
            <div
              class="flex flex-column justify-content-between align-items-center"
            >
              <div class="pt-2 w-full">
                <span class="p-float-label w-full">
                  <p-inputNumber [useGrouping]="false"></p-inputNumber>
                  <label>Cantidad de acometidas</label>
                </span>
              </div>
              <div class="flex-auto pt-5 w-full">
                <span class="p-float-label w-full">
                  <p-dropdown
                    class="w-full"
                    [options]="configService.catecteristicaLinea"
                    optionLabel="name"
                    optionValue="value"
                    [style]="{ minWidth: '100%', maxWidth: '100%' }"
                    placeholder="Característica de la línea"
                  ></p-dropdown>
                  <label> Característica de la línea </label>
                </span>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div
              class="flex flex-column justify-content-between align-items-center"
            >
              <div class="flex-auto pt-2 w-full">
                <span class="p-float-label w-full">
                  <p-dropdown
                    class="w-full"
                    [options]="configService.catecteristicaLinea"
                    optionLabel="name"
                    optionValue="value"
                    [style]="{ minWidth: '100%', maxWidth: '100%' }"
                    placeholder="Medida de protección"
                  ></p-dropdown>
                  <label> Medida de protección </label>
                </span>
              </div>
              <div class="flex-auto pt-5 w-full">
                <span class="p-float-label w-full">
                  <p-dropdown
                    class="w-full"
                    [options]="configService.catecteristicaLinea"
                    optionLabel="name"
                    optionValue="value"
                    [style]="{ minWidth: '100%', maxWidth: '100%' }"
                    placeholder="Tensión nominal"
                  ></p-dropdown>
                  <label> Tensión nominal </label>
                </span>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div
              class="flex flex-row flex-wrap align-items-center h-full gap-2 py-2"
            >
              <span class="w-8">
                ¿Cuenta con DPS que cumpla la normativa nacional vigente?
              </span>
              <p-toggleButton
                class="w-1"
                onLabel="SÍ"
                offLabel="NO"
              ></p-toggleButton>
            </div>
          </div>
        </div>
      </p-panel>
    </div>
    <div class="col-6">
      <p-panel
        class="w-full h-full gap-2"
        header="Acometidas de comunicaciones"
      >
        <div class="grid">
          <div class="col-4">
            <div
              class="flex flex-column justify-content-between align-items-center"
            >
              <div class="pt-2 w-full">
                <span class="p-float-label w-full">
                  <p-inputNumber [useGrouping]="false"></p-inputNumber>
                  <label>Cantidad de acometidas</label>
                </span>
              </div>
              <div class="flex-auto pt-5 w-full">
                <span class="p-float-label w-full">
                  <p-dropdown
                    class="w-full"
                    [options]="configService.catecteristicaLinea"
                    optionLabel="name"
                    optionValue="value"
                    [style]="{ minWidth: '100%', maxWidth: '100%' }"
                    placeholder="Característica de la línea"
                  ></p-dropdown>
                  <label> Característica de la línea </label>
                </span>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div
              class="flex flex-column justify-content-between align-items-center"
            >
              <div class="flex-auto pt-2 w-full">
                <span class="p-float-label w-full">
                  <p-dropdown
                    class="w-full"
                    [options]="configService.catecteristicaLinea"
                    optionLabel="name"
                    optionValue="value"
                    [style]="{ minWidth: '100%', maxWidth: '100%' }"
                    placeholder="Medida de protección"
                  ></p-dropdown>
                  <label> Medida de protección </label>
                </span>
              </div>
              <div class="flex-auto pt-5 w-full">
                <span class="p-float-label w-full">
                  <p-dropdown
                    class="w-full"
                    [options]="configService.catecteristicaLinea"
                    optionLabel="name"
                    optionValue="value"
                    [style]="{ minWidth: '100%', maxWidth: '100%' }"
                    placeholder="Tensión nominal"
                  ></p-dropdown>
                  <label> Tensión nominal </label>
                </span>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div
              class="flex flex-row flex-wrap align-items-center h-full gap-2 py-2"
            >
              <span class="w-8">
                ¿Cuenta con DPS que cumpla la normativa nacional vigente?
              </span>
              <p-toggleButton
                class="w-1"
                onLabel="SÍ"
                offLabel="NO"
              ></p-toggleButton>
            </div>
          </div>
        </div>
      </p-panel>
    </div>
  </div> -->
</ng-template>

<ng-template #resistiva [formGroup]="form">
  <div class="grid flex w-full">
    <div class="field col-2">
      <div class="p-inputgroup">
        <div class="p-float-label">
          <p-inputNumber [useGrouping]="false"></p-inputNumber>
          <label>Resistividad del terreno</label>
        </div>
        <span class="p-inputgroup-addon">m</span>
      </div>
    </div>
    <div class="col-2">
      <div class="p-inputgroup">
        <div class="p-float-label">
          <p-inputNumber [useGrouping]="false"></p-inputNumber>
          <label>Resistividad de pantalla</label>
        </div>
        <span class="p-inputgroup-addon">m</span>
      </div>
    </div>
  </div>
</ng-template>

<!-- <div class="col-3">
  <div class="flex flex-row align-items-center h-full">
    <label class="flex align-items-start w-8" for="aislamiento"
      >Aislamiento del nivel exterior</label
    >
    <p-toggleButton onLabel="SÍ" offLabel="NO"></p-toggleButton>
  </div>
</div> -->
